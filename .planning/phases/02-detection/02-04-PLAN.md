---
phase: 02-detection
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/detect.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User with stale GSD sees interactive prompt offering update options"
    - "User can choose to update GSD via git pull"
    - "User can dismiss warning and continue"
  artifacts:
    - path: "src/commands/detect.ts"
      provides: "Stale GSD handler with interactive prompt"
      contains: "gsdResult.fresh === false"
  key_links:
    - from: "src/commands/detect.ts"
      to: "select prompt"
      via: "stale condition check after line 88"
      pattern: "gsdResult\\.fresh\\s*===\\s*false"
---

<objective>
Close verification gap: Add interactive handling for stale GSD installations

Purpose: GSD-03 requirement states user should see freshness warning WITH option to update. Currently reporter displays warning but detect.ts has NO interactive handler for stale case.

Output: Updated detect.ts with stale GSD prompt offering update/continue/cancel options
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-detection/02-VERIFICATION.md

# Existing implementation
@src/commands/detect.ts
@src/lib/detection/freshness.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stale GSD interactive handler to detect.ts</name>
  <files>src/commands/detect.ts</files>
  <action>
Add stale GSD handler after the GSD not found block (after line 88) and before the OpenCode not found block (line 91).

The handler should:
1. Check condition: `gsdResult.found && gsdResult.valid && gsdResult.fresh === false`
2. Use select() from @clack/prompts with message about stale installation
3. Offer three options:
   - `update`: Run git pull to update GSD
   - `continue`: Dismiss warning and continue
   - `cancel`: Exit detection
4. Handle isCancel() for Ctrl+C
5. If `update` selected:
   - Import spawnSync from 'node:child_process'
   - Run `git pull` in gsdResult.path directory
   - Use spawnSync with 30s timeout, inherit stdio for user feedback
   - On success: log update complete message
   - On failure: log error and suggest manual update
6. If `continue` selected: just fall through (no action needed)
7. If `cancel` selected: set SUCCESS exit code and return

Also add helper function showGSDUpdateInstructions() that displays manual update steps (similar to existing install instructions pattern).

Follow existing code patterns:
- Use pc (picocolors) for colored output
- Use log.info() for informational messages
- Use ExitCode constants
- Match indentation and style of existing handlers
  </action>
  <verify>
1. `npm run build` succeeds without errors
2. `npm run typecheck` passes
3. Manual test: Modify freshness threshold temporarily or mock stale result to verify prompt appears
  </verify>
  <done>
When GSD is found but stale (>90 days old), user sees interactive prompt with options to update, continue, or cancel. Selecting update runs git pull in GSD directory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for stale GSD handler</name>
  <files>src/commands/detect.test.ts</files>
  <action>
Add test cases for the stale GSD flow. Since detect.ts uses interactive prompts, tests should:

1. Create or update src/commands/detect.test.ts
2. Mock @clack/prompts select() and text() functions
3. Mock detection functions to return stale GSD result:
   ```typescript
   {
     found: true,
     valid: true,
     fresh: false,
     daysOld: 120,
     path: '/mock/path/.claude'
   }
   ```
4. Test cases:
   - Stale GSD prompts user when not in quiet mode
   - Stale GSD skips prompt in quiet mode
   - Update option triggers git pull (mock spawnSync)
   - Continue option proceeds without action
   - Cancel option exits gracefully

Use vi.mock() for mocking (Vitest pattern established in 01-01).
  </action>
  <verify>
`npm test` passes including new stale handler tests
  </verify>
  <done>
Test suite covers stale GSD interactive flow with mocked prompts and git commands
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` - no compilation errors
2. `npm run typecheck` - type safety verified
3. `npm test` - all tests pass including new stale handler tests
4. Code review: stale handler follows same pattern as existing not-found handlers
</verification>

<success_criteria>
- detect.ts has handler for `gsdResult.found && gsdResult.valid && !gsdResult.fresh`
- User with stale GSD sees select() prompt with update/continue/cancel options
- Selecting "update" runs git pull in GSD directory
- Tests cover the new stale handling flow
- GSD-03 requirement fully satisfied (warn AND offer update)
</success_criteria>

<output>
After completion, create `.planning/phases/02-detection/02-04-SUMMARY.md`
</output>
