---
phase: 04-reports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/lib/transpilation/transformer.ts
  - src/lib/transpilation/transform-rules.json
  - src/lib/transpilation/orchestrator.ts
autonomous: true

must_haves:
  truths:
    - "Each gap includes source file path showing which GSD file caused it"
    - "Gaps are categorized by cause (unsupported, platform, missing-dependency)"
    - "Each gap includes actionable suggestion for user"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Enhanced TransformGaps interface with sourceFile, category, suggestion"
      exports: ["TransformGaps"]
      min_lines: 250
    - path: "src/lib/transpilation/transformer.ts"
      provides: "Populates enhanced gap fields during transformation"
      min_lines: 100
    - path: "src/lib/transpilation/transform-rules.json"
      provides: "Category and suggestion for each field mapping"
      min_lines: 60
    - path: "src/lib/transpilation/orchestrator.ts"
      provides: "Updated gap reporting to work with new object structure"
      min_lines: 285
  key_links:
    - from: "src/lib/transpilation/transformer.ts"
      to: "TransformGaps type"
      via: "creates gap objects with all fields"
      pattern: "sourceFile:.*category:.*suggestion:"
    - from: "src/lib/transpilation/transform-rules.json"
      to: "transformer.ts"
      via: "rules provide category/suggestion metadata"
      pattern: "category.*suggestion"
    - from: "src/lib/transpilation/orchestrator.ts"
      to: "TransformGaps type"
      via: "iterates over gap objects with field property"
      pattern: "gap\\.field"
---

<objective>
Enhance gap tracking to include source attribution, categorization, and actionable suggestions for reporting.

Purpose: Enable detailed shortfall reports showing users exactly which GSD features couldn't map, why, and what they can do about it.

Output: Enhanced TransformGaps type with sourceFile, category, and suggestion fields; transformer populates these fields from rules; orchestrator updated to handle new structure.
</objective>

<execution_context>
@C:\Users\Terence\code\gsd-for-hobos\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Terence\code\gsd-for-hobos\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\Terence\code\gsd-for-hobos\.planning\PROJECT.md
@C:\Users\Terence\code\gsd-for-hobos\.planning\ROADMAP.md
@C:\Users\Terence\code\gsd-for-hobos\.planning\STATE.md
@C:\Users\Terence\code\gsd-for-hobos\.planning\phases\04-reports\04-CONTEXT.md
@C:\Users\Terence\code\gsd-for-hobos\.planning\phases\04-reports\04-RESEARCH.md

# Prior phase summaries
@C:\Users\Terence\code\gsd-for-hobos\.planning\phases\03-transpilation\03-02-SUMMARY.md

# Source files
@C:\Users\Terence\code\gsd-for-hobos\src\types\index.ts
@C:\Users\Terence\code\gsd-for-hobos\src\lib\transpilation\transformer.ts
@C:\Users\Terence\code\gsd-for-hobos\src\lib\transpilation\transform-rules.json
@C:\Users\Terence\code\gsd-for-hobos\src\lib\transpilation\orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance TransformGaps type with reporting fields</name>
  <files>src/types/index.ts</files>
  <action>
Update the TransformGaps interface to support detailed reporting:

**BREAKING CHANGE:** This modifies the structure of unmappedFields and approximations arrays.

1. Enhance `unmappedFields` array items from `string[]` to objects with:
   - `field: string` - field name that couldn't be mapped
   - `value: unknown` - original value from GSD
   - `reason: string` - why it couldn't map
   - `sourceFile: string` - GSD file path containing this field
   - `category: 'unsupported' | 'platform' | 'missing-dependency'` - cause category
   - `suggestion: string` - actionable user suggestion

2. Enhance `approximations` array items to include:
   - Keep existing: `original`, `approximatedAs`, `reason`
   - Add: `sourceFile: string` - GSD file path containing approximated field
   - Add: `category: 'unsupported' | 'platform' | 'missing-dependency'` - cause category

Update JSDoc comments to explain new fields and their purpose for reporting.
  </action>
  <verify>
Run: npm run build

Check type compilation succeeds. Check TransformGaps export includes enhanced fields.
  </verify>
  <done>
TransformGaps interface includes sourceFile, category, suggestion fields. TypeScript compilation succeeds with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add category and suggestion metadata to transform rules</name>
  <files>src/lib/transpilation/transform-rules.json</files>
  <action>
For each section (agents, commands, models, config), enhance the rules schema:

1. Add `categories` object mapping field names to category:
   ```json
   "categories": {
     "tools": "platform",
     "variables": "platform",
     "conditionalExecution": "unsupported",
     "pluginRequirements": "missing-dependency"
   }
   ```

2. Add `suggestions` object mapping field names to user-actionable suggestions:
   ```json
   "suggestions": {
     "tools": "OpenCode uses tool registration. Register tools via OpenCode tool API.",
     "variables": "OpenCode uses template literals. Rewrite using {{variable}} syntax.",
     "conditionalExecution": "Not available in OpenCode. Use agent routing or multiple commands.",
     "pluginRequirements": "Install required OpenCode plugins manually via OpenCode plugin manager."
   }
   ```

Categories:
- `unsupported` = Feature doesn't exist in OpenCode (red in report)
- `platform` = Feature exists but syntax differs (yellow in report)
- `missing-dependency` = Requires external plugin/module (blue in report)

Include categories/suggestions for all fields in `approximations` sections. Add fallback category "unsupported" and suggestion "This GSD feature has no direct OpenCode equivalent" for unmapped fields without explicit rules.
  </action>
  <verify>
Run: cat src/lib/transpilation/transform-rules.json | grep -E "(categories|suggestions)"

Check that each section has categories and suggestions objects. Validate JSON syntax: npm run build
  </verify>
  <done>
transform-rules.json includes categories and suggestions for all approximated/unmapped fields. JSON is valid and builds without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update transformer to populate enhanced gap fields</name>
  <files>src/lib/transpilation/transformer.ts</files>
  <action>
Update transformToOpenCode function to populate new TransformGaps fields:

1. When creating unmappedFields entries:
   - Create objects instead of strings: `{ field, value, reason, sourceFile, category, suggestion }`
   - Load category from rules.categories[fieldName] (fallback: 'unsupported')
   - Load suggestion from rules.suggestions[fieldName] (fallback: 'This GSD feature has no direct OpenCode equivalent')
   - Track sourceFile from IR metadata (agents.xml, commands.xml, etc.)
   - Include field, value, reason (already exists), sourceFile, category, suggestion

2. When creating approximations entries:
   - Load category from rules.categories[original]
   - Track sourceFile from IR metadata
   - Keep existing original, approximatedAs, reason
   - Add sourceFile, category

3. Source file determination:
   - For agents: Use IR source path if available, else "agents.xml"
   - For commands: Use IR source path if available, else "commands.xml"
   - For models: Use IR source path if available, else "models.xml"

Load rules.categories and rules.suggestions when loading transform rules (loadTransformRules function). Handle missing categories/suggestions gracefully with fallbacks.
  </action>
  <verify>
Run: npm run build && npm test -- transformer.test.ts

Check build succeeds. Check tests pass. Manually inspect transformer.ts to confirm gap objects include sourceFile, category, suggestion.
  </verify>
  <done>
Transformer populates TransformGaps with sourceFile, category, and suggestion fields. Build succeeds. Tests pass with enhanced gap tracking.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update orchestrator gap reporting for new structure</name>
  <files>src/lib/transpilation/orchestrator.ts</files>
  <action>
Update orchestrator.ts to handle the new TransformGaps object structure (breaking change from Task 1):

**Lines 156-164 (dry-run gap reporting):**
```typescript
// Old (remove):
for (const field of gaps.unmappedFields) {
  log.warn(`  - Unmapped: ${field}`);
}

// New:
for (const gap of gaps.unmappedFields) {
  log.warn(`  - Unmapped: ${gap.field} (${gap.category})`);
  log.warn(`    Suggestion: ${gap.suggestion}`);
}
```

**Lines 261-270 (final gap reporting):**
```typescript
// Old (remove):
if (gaps && (gaps.unmappedFields.length > 0 || gaps.approximations.length > 0)) {
  log.warn('Some GSD features could not be directly mapped:');
  for (const field of gaps.unmappedFields) {
    log.warn(`  - Unmapped: ${field}`);
  }
  for (const approx of gaps.approximations) {
    log.warn(`  - Approximated: ${approx.original} → ${approx.approximatedAs}`);
  }
}

// New:
if (gaps && (gaps.unmappedFields.length > 0 || gaps.approximations.length > 0)) {
  log.warn('Some GSD features could not be directly mapped:');
  for (const gap of gaps.unmappedFields) {
    log.warn(`  - Unmapped: ${gap.field} (${gap.category})`);
    log.warn(`    Suggestion: ${gap.suggestion}`);
  }
  for (const approx of gaps.approximations) {
    log.warn(`  - Approximated: ${approx.original} → ${approx.approximatedAs} (${approx.category})`);
  }
}
```

Update variable names from `field` to `gap` to reflect object structure. Access properties via `gap.field`, `gap.category`, `gap.suggestion`.

Keep approximations handling similar, just add category display.
  </action>
  <verify>
Run: npm run build

Check TypeScript compilation succeeds with no type errors on orchestrator.ts lines 156-270. Manually inspect code to confirm gap iteration uses object properties.
  </verify>
  <done>
Orchestrator gap reporting updated to work with new object structure. TypeScript compiles without errors. Gap iteration uses gap.field, gap.category, gap.suggestion properties.
  </done>
</task>

</tasks>

<verification>
## Overall Phase Checks

1. TypeScript compilation succeeds with enhanced types
2. transform-rules.json includes categories and suggestions
3. Transformer creates gap objects with all required fields
4. Orchestrator gap reporting works with new object structure
5. Tests verify gap tracking includes sourceFile, category, suggestion
6. No compilation errors in affected files
</verification>

<success_criteria>
## Measurable Completion

- [ ] TransformGaps interface includes sourceFile, category, suggestion fields
- [ ] transform-rules.json has categories and suggestions for all fields
- [ ] Transformer populates all gap fields during transformation
- [ ] Orchestrator iterates over gap objects using .field property
- [ ] npm run build succeeds with no TypeScript errors
- [ ] npm test passes with enhanced gap tracking
- [ ] Example gap object: `{ field: 'variables', value: {...}, reason: '...', sourceFile: 'commands.xml', category: 'platform', suggestion: '...' }`
</success_criteria>

<output>
After completion, create `.planning/phases/04-reports/04-01-SUMMARY.md` documenting:
- Enhanced TransformGaps structure (breaking change)
- New transform-rules fields (categories, suggestions)
- Transformer changes for gap population
- Orchestrator updates for object iteration
- Example gap objects with all fields
</output>
