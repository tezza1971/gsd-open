---
phase: 03-gsdo-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/enhancer/engine.ts
  - src/lib/enhancer/engine.test.ts
  - src/lib/enhancer/types.ts
autonomous: true

must_haves:
  truths:
    - "Enhancement engine can read install.log for transpilation context"
    - "Enhancement engine can read cached OpenCode docs from ~/.gsdo/cache/"
    - "Enhancement engine can read current commands.json"
    - "Enhancement engine creates timestamped backups before modifications"
    - "Enhancement engine writes enhanced commands back to commands.json"
  artifacts:
    - path: "src/lib/enhancer/types.ts"
      provides: "Type definitions for enhancement context and results"
      exports: ["EnhancementContext", "EnhancementResult"]
    - path: "src/lib/enhancer/engine.ts"
      provides: "Core enhancement engine with context loading and command updates"
      exports: ["loadEnhancementContext", "backupCommandsJson", "writeEnhancedCommands"]
      min_lines: 100
    - path: "src/lib/enhancer/engine.test.ts"
      provides: "Test suite for enhancement engine core functions"
      min_lines: 50
  key_links:
    - from: "src/lib/enhancer/engine.ts"
      to: "~/.gsdo/install.log"
      via: "fs.readFile"
      pattern: "readFile.*install\\.log"
    - from: "src/lib/enhancer/engine.ts"
      to: "~/.gsdo/cache/docs-opencode/README.md"
      via: "fs.readFile"
      pattern: "readFile.*README\\.md"
    - from: "src/lib/enhancer/engine.ts"
      to: "commands.json"
      via: "commands-manager functions"
      pattern: "(readCommands|writeCommands)"
---

<objective>
Create the core enhancement engine that loads context (install.log, cached docs, commands.json) and provides safe command update operations with automatic backup.

Purpose: Establishes the foundation for LLM-powered command enhancement by handling all file I/O and state management.
Output: Enhancement engine with context loading, backup mechanism, and command persistence.
</objective>

<execution_context>
@C:\Users\Terence\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Terence\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\Terence\code\gsd-open\.planning\PROJECT.md
@C:\Users\Terence\code\gsd-open\.planning\ROADMAP.md
@C:\Users\Terence\code\gsd-open\.planning\STATE.md
@C:\Users\Terence\code\gsd-open\.planning\phases\03-gsdo-command\03-gsdo-command-CONTEXT.md

# Prior phase context
@C:\Users\Terence\code\gsd-open\.planning\phases\02-documentation-cache\02-02-SUMMARY.md

# Existing code
@C:\Users\Terence\code\gsd-open\src\lib\installer\commands-manager.ts
@C:\Users\Terence\code\gsd-open\src\lib\cache\manager.ts
@C:\Users\Terence\code\gsd-open\src\lib\cache\paths.ts
@C:\Users\Terence\code\gsd-open\src\lib\transpiler\types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enhancement types and context loader</name>
  <files>
    src/lib/enhancer/types.ts
    src/lib/enhancer/engine.ts
  </files>
  <action>
Create type definitions and context loading function for enhancement engine.

**types.ts** - Define enhancement data structures:
- `EnhancementContext` interface:
  - `installLog: string` (raw install.log content)
  - `opencodeDocsCache: string` (cached README.md content)
  - `gsdSkillsPath: string` (path to ~/.claude/get-shit-done/skills/)
  - `opencodeConfigPath: string` (path to OpenCode config directory)
  - `commands: OpenCodeCommand[]` (current commands from commands.json)
- `EnhancementResult` interface:
  - `commandName: string`
  - `enhanced: boolean` (true if changes made)
  - `changes: string[]` (list of what was fixed/improved)
  - `error?: string` (if enhancement failed for this command)

**engine.ts** - Implement `loadEnhancementContext()`:
1. Detect OpenCode config path (reuse detectOpenCode from detector.ts)
2. Detect GSD installation path (reuse detectGsd from detector.ts)
3. Read install.log from ~/.gsdo/install.log (create parent dir if needed, return empty string if missing)
4. Read cached docs from ~/.gsdo/cache/docs-opencode/README.md (use cache paths helper, return empty string if missing)
5. Read current commands.json (use readCommands from commands-manager.ts)
6. Return EnhancementContext with all loaded data
7. Handle errors gracefully - return partial context rather than throwing

Use Node.js built-in modules only (fs/promises, path).
Import from existing modules where applicable (detector, commands-manager, cache/paths).
  </action>
  <verify>
npm test -- engine.test.ts shows loadEnhancementContext returns valid context structure
  </verify>
  <done>
EnhancementContext type exported, loadEnhancementContext function reads all required files and returns populated context object
  </done>
</task>

<task type="auto">
  <name>Task 2: Create backup and write functions</name>
  <files>
    src/lib/enhancer/engine.ts
    src/lib/enhancer/engine.test.ts
  </files>
  <action>
Add backup and write operations to enhancement engine.

**engine.ts** - Implement backup and write functions:

1. `backupCommandsJson(opencodeConfigPath: string): Promise<string>`
   - Read current commands.json (use readCommands)
   - Generate timestamped backup filename: `commands.json.YYYY-MM-DDTHH-mm-ss.backup`
   - Write backup to OpenCode config directory
   - Return backup filename
   - Skip backup if commands.json doesn't exist (return empty string)

2. `writeEnhancedCommands(opencodeConfigPath: string, commands: OpenCodeCommand[]): void`
   - Use writeCommands from commands-manager to persist enhanced commands
   - This is a thin wrapper for consistency with enhancement API

**engine.test.ts** - Create test suite:
1. Test loadEnhancementContext with mocked filesystem
   - Mock detectGsd, detectOpenCode, readFile, readCommands
   - Verify context structure returned
   - Test graceful handling of missing files (empty strings, not errors)

2. Test backupCommandsJson
   - Mock readCommands and writeFile
   - Verify timestamped filename format
   - Verify backup content matches original

3. Test writeEnhancedCommands
   - Mock writeCommands
   - Verify delegation to commands-manager

Use vitest for testing. Mock filesystem operations.
  </action>
  <verify>
npm test shows all engine.test.ts tests passing (at least 5 test cases covering context loading, backup, and write operations)
  </verify>
  <done>
Backup mechanism creates timestamped .backup files, writeEnhancedCommands safely persists changes, test suite validates all core functions
  </done>
</task>

</tasks>

<verification>
- [ ] EnhancementContext type includes all required fields (installLog, opencodeDocsCache, gsdSkillsPath, opencodeConfigPath, commands)
- [ ] EnhancementResult type tracks per-command enhancement status
- [ ] loadEnhancementContext returns partial context when files missing (no errors thrown)
- [ ] backupCommandsJson creates timestamped backups before modifications
- [ ] writeEnhancedCommands delegates to commands-manager for persistence
- [ ] Test suite covers happy path and missing file scenarios
- [ ] All tests pass (npm test)
</verification>

<success_criteria>
- Enhancement engine can load all context required for LLM enhancement (install.log, docs cache, commands.json)
- Backup mechanism prevents data loss during enhancement
- Write operations safely persist enhanced commands
- Missing files handled gracefully (partial context, not failures)
- Test coverage validates core functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-gsdo-command/03-01-SUMMARY.md`
</output>
