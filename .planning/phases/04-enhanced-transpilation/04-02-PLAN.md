---
phase: 04-enhanced-transpilation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/transpiler/variable-parser.ts
  - src/lib/transpiler/variable-parser.test.ts
  - src/lib/transpiler/types.ts
  - src/lib/transpiler/converter.ts
autonomous: true

must_haves:
  truths:
    - "Installer parses template variables ({{var}}) from prompt templates"
    - "Parsed variables are included in OpenCode command schema"
    - "Variable parser handles nested braces and edge cases"
  artifacts:
    - path: "src/lib/transpiler/variable-parser.ts"
      provides: "Variable parsing logic"
      exports: ["parseTemplateVariables"]
      min_lines: 30
    - path: "src/lib/transpiler/variable-parser.test.ts"
      provides: "Variable parser tests"
      contains: "describe.*parseTemplateVariables"
    - path: "src/lib/transpiler/types.ts"
      provides: "Updated OpenCodeCommand type with variables field"
      contains: "variables\\?:"
    - path: "src/lib/transpiler/converter.ts"
      provides: "Converter using variable parser"
      contains: "parseTemplateVariables"
  key_links:
    - from: "src/lib/transpiler/converter.ts"
      to: "src/lib/transpiler/variable-parser.ts"
      via: "import and call parseTemplateVariables"
      pattern: "import.*parseTemplateVariables.*from.*variable-parser"
    - from: "src/lib/transpiler/converter.ts"
      to: "parseTemplateVariables(promptTemplate)"
      via: "extracts variables from template"
      pattern: "parseTemplateVariables\\(promptTemplate\\)"
---

<objective>
Parse template variables from GSD prompt templates and include them in OpenCode command schema.

Purpose: GSD commands use template variables like `{{phase}}`, `{{context}}`, `{{plan}}` to parameterize prompts. OpenCode needs to know what variables exist in each command's template.

Output: Variable parser module that extracts `{{var}}` patterns and enhances OpenCode command schema with variables metadata.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current transpiler implementation
@src/lib/transpiler/converter.ts
@src/lib/transpiler/types.ts

# Reference: Variable patterns in GSD
@gsdo-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create variable parser module</name>
  <files>src/lib/transpiler/variable-parser.ts</files>
  <action>
Create variable parser module that extracts `{{variable}}` patterns from prompt templates.

**Implementation requirements**:

1. **Export function**: `parseTemplateVariables(template: string): string[]`

2. **Parsing logic**:
   - Use regex to find all `{{...}}` patterns
   - Extract variable names (content between braces)
   - Return unique array of variable names
   - Handle edge cases: nested braces, malformed patterns

3. **Regex pattern**: `/\{\{([^}]+)\}\}/g`
   - Matches: `{{phase}}`, `{{context}}`, `{{plan}}`
   - Extracts: `phase`, `context`, `plan`
   - Handles multiple occurrences (global flag)

4. **Deduplication**:
   - If `{{phase}}` appears multiple times, only return `phase` once
   - Use Set to collect unique variable names

5. **Edge case handling**:
   - Empty template: Return empty array
   - No variables: Return empty array
   - Malformed `{{unclosed`: Ignore, don't break
   - Nested `{{outer {{inner}}}}`: Extract `inner` only (greedy match stops at first `}}`)

**Example transformations**:

Template: `Create plan for {{phase}} using {{context}}`
Output: `['phase', 'context']`

Template: `No variables here`
Output: `[]`

Template: `Duplicate {{var}} and {{var}} again`
Output: `['var']`

**Code structure**:
```typescript
/**
 * Parses template variables from a prompt template string
 *
 * Extracts all {{variable}} patterns and returns unique variable names.
 *
 * @param template - Prompt template containing {{var}} patterns
 * @returns Array of unique variable names (without braces)
 */
export function parseTemplateVariables(template: string): string[] {
  if (!template) return [];

  const variablePattern = /\{\{([^}]+)\}\}/g;
  const variables = new Set<string>();

  let match;
  while ((match = variablePattern.exec(template)) !== null) {
    variables.add(match[1].trim());
  }

  return Array.from(variables);
}
```
  </action>
  <verify>npm test -- variable-parser.test.ts</verify>
  <done>Variable parser exists, exports parseTemplateVariables function, extracts {{var}} patterns correctly</done>
</task>

<task type="auto">
  <name>Task 2: Write variable parser tests and update type schema</name>
  <files>src/lib/transpiler/variable-parser.test.ts, src/lib/transpiler/types.ts</files>
  <action>
Create variable parser tests and update OpenCodeCommand type to include variables field.

**Part 1: Test suite** (variable-parser.test.ts):

```typescript
import { describe, it, expect } from 'vitest';
import { parseTemplateVariables } from './variable-parser.js';

describe('parseTemplateVariables', () => {
  it('extracts single variable', () => {
    const template = 'Create plan for {{phase}}';
    expect(parseTemplateVariables(template)).toEqual(['phase']);
  });

  it('extracts multiple variables', () => {
    const template = 'Use {{phase}} and {{context}} to build {{output}}';
    expect(parseTemplateVariables(template)).toEqual(['phase', 'context', 'output']);
  });

  it('deduplicates repeated variables', () => {
    const template = '{{var}} appears {{var}} multiple {{var}} times';
    expect(parseTemplateVariables(template)).toEqual(['var']);
  });

  it('returns empty array for template without variables', () => {
    const template = 'No variables here';
    expect(parseTemplateVariables(template)).toEqual([]);
  });

  it('returns empty array for empty string', () => {
    expect(parseTemplateVariables('')).toEqual([]);
  });

  it('handles whitespace in variable names', () => {
    const template = '{{ phase }} and {{context}}';
    expect(parseTemplateVariables(template)).toEqual(['phase', 'context']);
  });
});
```

**Part 2: Type schema update** (types.ts):

Update `OpenCodeCommand` interface to include optional `variables` field:

```typescript
/**
 * OpenCode command schema (Phase 4: includes variables)
 */
export interface OpenCodeCommand {
  /** Converted name, e.g., "gsd-plan-phase" (no slash, colon->dash) */
  name: string;

  /** From GSD or default description */
  description: string;

  /** Extracted prompt template (Phase 4) */
  promptTemplate: string;

  /** Template variables parsed from promptTemplate (Phase 4) */
  variables?: string[];
}
```

Update the comment at top of file from "Phase 1" to "Phase 4" to reflect template extraction and variable parsing.

Run tests: `npm test`
  </action>
  <verify>npm test -- variable-parser.test.ts shows all tests passing, types.ts includes variables field</verify>
  <done>Variable parser test suite exists with 6+ test cases, OpenCodeCommand type includes variables field, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Integrate variable parser into converter</name>
  <files>src/lib/transpiler/converter.ts</files>
  <action>
Update converter.ts to parse variables and include them in OpenCode command schema.

**Changes to make**:

1. **Import variable parser**:
```typescript
import { parseTemplateVariables } from './variable-parser.js';
```

2. **Update convertCommand function** (after promptTemplate extraction, around line 38):

Add variable parsing:
```typescript
// Phase 4: Extract clean prompt template from markdown
const promptTemplate = extractPromptTemplate(gsd.rawContent);

// Phase 4: Parse template variables
const variables = parseTemplateVariables(promptTemplate);
```

3. **Update command object creation** (around line 46):
```typescript
const command: OpenCodeCommand = {
  name,
  description,
  promptTemplate,
  variables: variables.length > 0 ? variables : undefined, // Only include if variables exist
};
```

4. **Update comment** to reflect Phase 4 variable parsing

**Testing**:
- Run converter tests: `npm test -- converter.test.ts`
- Run integration tests: `npm test`
- Verify commands with variables include the `variables` field
- Verify commands without variables omit the field (undefined)

**Expected behavior**:
- Template with `{{phase}}` and `{{context}}` → `variables: ['phase', 'context']`
- Template with no variables → `variables` field not included
  </action>
  <verify>npm test shows all tests passing, transpiled commands include variables field when template has {{var}} patterns</verify>
  <done>Converter parses template variables and includes them in OpenCode command schema, all tests passing</done>
</task>

</tasks>

<verification>
Run full test suite to verify variable parsing integration:

```bash
npm test
```

Expected results:
- Variable parser tests pass
- Converter tests pass with variable parsing
- Integration tests pass with variable metadata

Spot check: Read a transpiled command from test output and verify `variables` field contains array of variable names extracted from promptTemplate.
</verification>

<success_criteria>
1. Variable parser module exists with parseTemplateVariables export
2. Parser extracts {{var}} patterns using regex
3. Parser deduplicates repeated variables
4. Parser handles edge cases (empty, no variables, malformed)
5. OpenCodeCommand type includes variables field
6. Converter integrated with variable parser
7. All tests pass
8. Transpiled commands include variables metadata when applicable
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-transpilation/04-02-SUMMARY.md`
</output>
