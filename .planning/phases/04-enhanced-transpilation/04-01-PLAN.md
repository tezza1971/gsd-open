---
phase: 04-enhanced-transpilation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/transpiler/template-extractor.ts
  - src/lib/transpiler/template-extractor.test.ts
  - src/lib/transpiler/converter.ts
autonomous: true

must_haves:
  truths:
    - "Installer extracts clean prompt template from GSD markdown (not entire file)"
    - "Extractor handles GSD files with frontmatter, headings, and mixed content"
    - "Extractor gracefully handles edge cases (empty files, no template section)"
  artifacts:
    - path: "src/lib/transpiler/template-extractor.ts"
      provides: "Template extraction logic"
      exports: ["extractPromptTemplate"]
      min_lines: 40
    - path: "src/lib/transpiler/template-extractor.test.ts"
      provides: "Template extraction tests"
      contains: "describe.*extractPromptTemplate"
    - path: "src/lib/transpiler/converter.ts"
      provides: "Updated converter using template extractor"
      contains: "extractPromptTemplate"
  key_links:
    - from: "src/lib/transpiler/converter.ts"
      to: "src/lib/transpiler/template-extractor.ts"
      via: "import and call extractPromptTemplate"
      pattern: "import.*extractPromptTemplate.*from.*template-extractor"
    - from: "src/lib/transpiler/converter.ts"
      to: "extractPromptTemplate(gsd.rawContent)"
      via: "replaces rawContent passthrough"
      pattern: "extractPromptTemplate\\(gsd\\.rawContent\\)"
---

<objective>
Extract clean prompt templates from GSD markdown files instead of passing through entire file content.

Purpose: Phase 1 used raw markdown passthrough (`promptTemplate = gsd.rawContent`). Phase 4 extracts the actual prompt template section, removing frontmatter, metadata, and GSD-specific structural elements.

Output: Template extractor module that converts GSD markdown to clean OpenCode prompt templates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current transpiler implementation
@src/lib/transpiler/converter.ts
@src/lib/transpiler/types.ts
@src/lib/transpiler/scanner.ts

# Reference: GSD command structure from spec
@gsdo-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template extraction module</name>
  <files>src/lib/transpiler/template-extractor.ts</files>
  <action>
Create template extraction module that converts GSD markdown to clean OpenCode prompt templates.

**Implementation requirements:**

1. **Export function**: `extractPromptTemplate(rawContent: string): string`

2. **Extraction logic**:
   - Remove YAML frontmatter (between `---` delimiters)
   - Remove top-level headings (# and ##) that are metadata/structure
   - Preserve markdown content that represents the actual prompt
   - Handle edge cases: empty files, no clear template section
   - Return original content if extraction fails (graceful degradation)

3. **Pattern matching approach** (algorithmic, no LLM):
   - Strip frontmatter: Remove content between first `---` and second `---`
   - Identify template start: After frontmatter, look for first significant markdown block
   - Clean structural elements: Remove GSD-specific metadata headings
   - Preserve prompt content: Keep markdown that would be sent to LLM

4. **Graceful degradation**:
   - If no frontmatter: Process whole file
   - If unclear structure: Return trimmed original content
   - If empty: Return empty string with warning flag

**Example transformation**:

Before (GSD markdown):
```
---
description: Plan a phase
---

# Plan Phase Command

This command helps plan phases.

## Role
You are a GSD planner...

## Task
Create a detailed plan for {{phase}}...
```

After (OpenCode prompt):
```
You are a GSD planner...

Create a detailed plan for {{phase}}...
```

**Code structure**:
- Single exported function
- Helper functions for frontmatter removal, heading cleanup
- Comprehensive JSDoc comments
- No external dependencies (use Node.js string operations)
  </action>
  <verify>npm test -- template-extractor.test.ts</verify>
  <done>Template extractor exists, exports extractPromptTemplate function, handles frontmatter removal and content extraction</done>
</task>

<task type="auto">
  <name>Task 2: Write template extractor tests</name>
  <files>src/lib/transpiler/template-extractor.test.ts</files>
  <action>
Create comprehensive test suite for template extraction using Vitest.

**Test cases to cover**:

1. **Standard GSD markdown**:
   - Input: Frontmatter + headings + prompt content
   - Expected: Clean prompt without frontmatter/metadata headings

2. **Edge cases**:
   - No frontmatter (just markdown content)
   - Empty file
   - Only frontmatter (no content)
   - Malformed frontmatter (missing closing `---`)

3. **Content preservation**:
   - Nested headings in prompt (### subsections) should be kept
   - Code blocks in prompt should be preserved
   - Template variables ({{var}}) should be preserved

4. **Graceful degradation**:
   - Unclear structure returns original content
   - Never throws errors, always returns string

**Test structure**:
```typescript
import { describe, it, expect } from 'vitest';
import { extractPromptTemplate } from './template-extractor.js';

describe('extractPromptTemplate', () => {
  it('removes frontmatter from standard GSD markdown', () => { ... });
  it('preserves template variables', () => { ... });
  it('handles missing frontmatter gracefully', () => { ... });
  it('returns empty string for empty input', () => { ... });
  // ... more test cases
});
```

Run tests with `npm test` to verify all cases pass.
  </action>
  <verify>npm test -- template-extractor.test.ts shows all tests passing</verify>
  <done>Template extractor test suite exists with 5+ test cases covering standard and edge cases, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Integrate template extractor into converter</name>
  <files>src/lib/transpiler/converter.ts</files>
  <action>
Update converter.ts to use template extraction instead of raw content passthrough.

**Changes to make**:

1. **Import template extractor**:
```typescript
import { extractPromptTemplate } from './template-extractor.js';
```

2. **Update convertCommand function** (around line 36):

Replace:
```typescript
// Phase 1: Use raw markdown content as promptTemplate
// Future phases will extract and transform the template
const promptTemplate = gsd.rawContent;
```

With:
```typescript
// Phase 4: Extract clean prompt template from markdown
const promptTemplate = extractPromptTemplate(gsd.rawContent);
```

3. **Update comment** to reflect Phase 4 completion

4. **No other changes needed**: Rest of converter logic stays the same (name conversion, description extraction, warning collection)

**Testing**:
- Run existing converter tests: `npm test -- converter.test.ts`
- Verify integration tests still pass: `npm test`
- No breaking changes expected (template extraction gracefully degrades)
  </action>
  <verify>npm test shows all converter and integration tests passing with template extraction integrated</verify>
  <done>Converter uses extractPromptTemplate instead of raw content, all tests passing, transpilation produces clean OpenCode prompts</done>
</task>

</tasks>

<verification>
Run full test suite to verify template extraction integration:

```bash
npm test
```

Expected results:
- Template extractor tests pass
- Converter tests pass with template extraction
- Integration tests pass with enhanced transpilation

Spot check: Read a transpiled command from test output and verify promptTemplate contains clean prompt content (no frontmatter, no structural metadata).
</verification>

<success_criteria>
1. Template extractor module exists with extractPromptTemplate export
2. Extractor removes frontmatter and structural headings
3. Extractor preserves prompt content and template variables
4. Extractor handles edge cases gracefully (no errors, sensible defaults)
5. Converter integrated with template extractor
6. All existing tests pass (no breaking changes)
7. Transpiled commands have clean promptTemplate field
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-transpilation/04-01-SUMMARY.md`
</output>
