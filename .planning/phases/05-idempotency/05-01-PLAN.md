---
phase: 05-idempotency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/idempotency/state-manager.ts
  - src/lib/idempotency/state-manager.test.ts
  - src/lib/idempotency/types.ts
autonomous: true

must_haves:
  truths:
    - "Installer can read previous import state from ~/.gsdo/last-imported-gsd"
    - "Installer can write new import state after successful transpilation"
    - "State tracks all skill file paths with their timestamps"
  artifacts:
    - path: "src/lib/idempotency/types.ts"
      provides: "Type definitions for import state"
      exports: ["ImportState", "SkillFileRecord"]
    - path: "src/lib/idempotency/state-manager.ts"
      provides: "Read/write operations for state file"
      exports: ["readImportState", "writeImportState", "getStatePath"]
      min_lines: 80
    - path: "src/lib/idempotency/state-manager.test.ts"
      provides: "Test coverage for state operations"
      min_lines: 60
  key_links:
    - from: "src/cli.ts"
      to: "state-manager.ts"
      via: "import { readImportState, writeImportState }"
      pattern: "from.*idempotency/state-manager"
---

<objective>
Create state file infrastructure for tracking GSD import history.

Purpose: Enable idempotency by persisting which files were imported and when, so subsequent runs can detect changes efficiently.

Output: State manager module that reads/writes `~/.gsdo/last-imported-gsd` with skill file timestamps.
</objective>

<execution_context>
@C:/Users/Terence/code/gsd-open/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Terence/code/gsd-open/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Terence/code/gsd-open/.planning/PROJECT.md
@C:/Users/Terence/code/gsd-open/.planning/ROADMAP.md
@C:/Users/Terence/code/gsd-open/.planning/STATE.md
@C:/Users/Terence/code/gsd-open/.planning/phases/05-idempotency/05-CONTEXT.md

# Reference existing patterns
@C:/Users/Terence/code/gsd-open/src/lib/cache/manager.ts
@C:/Users/Terence/code/gsd-open/src/lib/cache/types.ts
@C:/Users/Terence/code/gsd-open/src/lib/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state file types and manager</name>
  <files>
    src/lib/idempotency/types.ts
    src/lib/idempotency/state-manager.ts
    src/lib/idempotency/state-manager.test.ts
  </files>
  <action>
Create TypeScript types for import state tracking:

**types.ts:**
- `SkillFileRecord` interface: `{ path: string, mtime: number }` (file path + modified timestamp in milliseconds)
- `ImportState` interface: `{ importedAt: string, docsCachedAt: string, skills: SkillFileRecord[] }`
  - `importedAt`: ISO 8601 timestamp of last import
  - `docsCachedAt`: ISO 8601 timestamp when docs were cached (for independent cache freshness)
  - `skills`: Array of skill file records

**state-manager.ts:**
- `getStatePath(): string` - Returns `~/.gsdo/last-imported-gsd` (use existing home resolution pattern from paths.ts)
- `readImportState(): ImportState | null` - Reads JSON from state file, returns null if missing/corrupted
- `writeImportState(state: ImportState): void` - Writes JSON to state file (create parent directory if needed)
- `buildCurrentState(gsdPath: string): ImportState` - Scans skills/ directory, builds state from current filesystem
  - Use `readdirSync` to find all `.md` files starting with `gsd:`
  - Get `statSync(file).mtimeMs` for each file
  - Sort skills array by path (deterministic ordering for comparison)
  - Set `importedAt` to current ISO 8601 timestamp
  - Set `docsCachedAt` to empty string (CLI will update this)

**state-manager.test.ts:**
- Test `readImportState()` returns null for missing file
- Test `readImportState()` returns null for corrupted JSON
- Test `writeImportState()` creates valid JSON file
- Test `buildCurrentState()` scans directory and extracts mtimes correctly
- Test round-trip (write then read produces same state)

Use Node.js built-in modules only (fs, fs/promises, path). Follow patterns from cache/manager.ts for file operations.
  </action>
  <verify>
npm test -- state-manager.test.ts
  </verify>
  <done>
All tests pass. State manager can read/write import state to ~/.gsdo/last-imported-gsd and build state from current filesystem.
  </done>
</task>

</tasks>

<verification>
- [ ] Types exported from types.ts (ImportState, SkillFileRecord)
- [ ] state-manager.ts exports readImportState, writeImportState, buildCurrentState, getStatePath
- [ ] Tests pass for missing file, corrupted JSON, round-trip, and buildCurrentState
- [ ] State file uses JSON format for easy inspection
</verification>

<success_criteria>
State file infrastructure exists and tested. CLI can persist/retrieve import history to detect changes in next plan.
</success_criteria>

<output>
After completion, create `.planning/phases/05-idempotency/05-01-SUMMARY.md`
</output>
